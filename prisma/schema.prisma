// This is your Prisma schema file for the Facet ontology

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model LegalEntity {
  id          String      @id @default(cuid())
  name        String
  entityType  String      // e.g., "Company", "Individual", "Government"
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  agreements  Agreement[]

  @@index([name])
}

model Agreement {
  id          String      @id @default(cuid())
  title       String
  fullText    String      // Complete agreement text
  entityId    String
  status      String      @default("draft") // draft, analyzed, reviewed
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  analyzedAt  DateTime?

  // Relations
  entity      LegalEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  clauses     Clause[]

  @@index([entityId])
  @@index([status])
}

model Clause {
  id          String      @id @default(cuid())
  agreementId String
  clauseNumber String?    // e.g., "3.2", "Section A"
  title       String?
  content     String      // Clause text
  startOffset Int?        // Character offset in agreement
  endOffset   Int?        // Character offset in agreement
  createdAt   DateTime    @default(now())

  // Relations
  agreement   Agreement   @relation(fields: [agreementId], references: [id], onDelete: Cascade)
  assessments RiskAssessment[]

  @@index([agreementId])
}

model PolicyRule {
  id          String      @id @default(cuid())
  name        String
  description String
  ruleText    String      // Detailed rule specification
  category    String      // e.g., "Data Privacy", "Liability", "Termination"
  severity    String      @default("medium") // low, medium, high
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  assessments RiskAssessment[]

  @@index([category])
  @@index([isActive])
}

model RiskAssessment {
  id          String      @id @default(cuid())
  clauseId    String
  ruleId      String
  riskLevel   String      // "green", "yellow", "red"
  explanation String      // LLM-generated explanation
  confidence  Float?      // 0.0 to 1.0
  createdAt   DateTime    @default(now())

  // Relations
  clause      Clause      @relation(fields: [clauseId], references: [id], onDelete: Cascade)
  rule        PolicyRule  @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  evidence    FullText[]

  @@index([clauseId])
  @@index([ruleId])
  @@index([riskLevel])
}

model FullText {
  id              String          @id @default(cuid())
  assessmentId    String
  evidenceText    String          // Exact text snippet that triggered the rule
  startOffset     Int             // Character offset in clause/agreement
  endOffset       Int             // Character offset in clause/agreement
  contextBefore   String?         // Optional context
  contextAfter    String?         // Optional context
  createdAt       DateTime        @default(now())

  // Relations
  assessment      RiskAssessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
}

